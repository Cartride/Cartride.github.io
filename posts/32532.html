<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>常用内建模块（下） - MCFON</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="MCFON"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="MCFON"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Python之所以自称 “batteries included”，就是因为内置了许多非常有用的模块，无需额外安装和配置，即可直接使用。 本章将介绍一些常用的内建模块。"><meta property="og:type" content="blog"><meta property="og:title" content="常用内建模块（下）"><meta property="og:url" content="https://hunlp.com/posts/32532.html"><meta property="og:site_name" content="MCFON"><meta property="og:description" content="Python之所以自称 “batteries included”，就是因为内置了许多非常有用的模块，无需额外安装和配置，即可直接使用。 本章将介绍一些常用的内建模块。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://hunlp.com/img/og_image.png"><meta property="article:published_time" content="2017-06-27T17:35:34.000Z"><meta property="article:modified_time" content="2021-06-08T12:38:05.027Z"><meta property="article:author" content="ฅ´ω`ฅ"><meta property="article:tag" content="笔记"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://hunlp.com/posts/32532.html"},"headline":"常用内建模块（下）","image":["https://hunlp.com/img/og_image.png"],"datePublished":"2017-06-27T17:35:34.000Z","dateModified":"2021-06-08T12:38:05.027Z","author":{"@type":"Person","name":"ฅ´ω`ฅ"},"publisher":{"@type":"Organization","name":"MCFON","logo":{"@type":"ImageObject","url":"https://hunlp.com/img/logo.png"}},"description":"Python之所以自称 “batteries included”，就是因为内置了许多非常有用的模块，无需额外安装和配置，即可直接使用。 本章将介绍一些常用的内建模块。"}</script><link rel="canonical" href="https://hunlp.com/posts/32532.html"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?b99420d7a06d2b3361a8efeaf6e20764";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-131608076-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-131608076-1');</script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="MCFON" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a><a class="navbar-item" href="/friend">友链</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal"><i class="fas fa-angle-double-right"></i>常用内建模块（下）</h1><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><i class="far fa-calendar-alt"> </i><time dateTime="${date_xml(page.date)}" title="${date_xml(page.date)}">2017-06-28</time></span><span class="level-item is-hidden-mobile"><i class="far fa-calendar-check"> </i><time dateTime="${date_xml(page.updated)}" title="${date_xml(page.updated)}">2021-06-08</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a></span><span class="level-item">1 小时读完 (大约6736个字)</span></div></div><div class="content"><p>Python之所以自称 <strong>“batteries included”</strong>，就是因为内置了许多非常有用的模块，无需额外安装和配置，即可直接使用。</p>
<p>本章将介绍一些常用的内建模块。 <span id="more"></span></p>
<h2 id="itertools">itertools</h2>
<h3 id="简介">简介</h3>
<p>Python的内建模块 <code>itertools</code> 提供了非常有用的用于操作迭代对象的函数。我们首先看看 <code>itertools</code> 提供的几个“无限”迭代器：</p>
<hr />
<h3 id="count">count</h3>
<p><code>count()</code> 返回的是一个无限的迭代器，默认初始值为0，步长为1（按Python的传参规则，只传入一个参数时，传入的参数被视作初始值）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> itertools</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>natuals = itertools.count(<span class="number">1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> n <span class="keyword">in</span> natuals:</span><br><span class="line"><span class="meta">... </span>    <span class="built_in">print</span>(n)</span><br><span class="line">...</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>上述代码会打印出自然数序列，但问题是它根本停不下来，只能按 <code>Ctrl+C</code> 退出。</p>
<hr />
<h3 id="cycle">cycle</h3>
<p><code>cycle()</code> 会把传入的<strong>一个序列</strong>无限重复下去：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> itertools</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cs = itertools.cycle(<span class="string">&#x27;ABC&#x27;</span>) <span class="comment"># 注意字符串也是序列的一种，还可以是列表、元组等</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> c <span class="keyword">in</span> cs:</span><br><span class="line"><span class="meta">... </span>    <span class="built_in">print</span>(c)</span><br><span class="line">...</span><br><span class="line"><span class="string">&#x27;A&#x27;</span></span><br><span class="line"><span class="string">&#x27;B&#x27;</span></span><br><span class="line"><span class="string">&#x27;C&#x27;</span></span><br><span class="line"><span class="string">&#x27;A&#x27;</span></span><br><span class="line"><span class="string">&#x27;B&#x27;</span></span><br><span class="line"><span class="string">&#x27;C&#x27;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>同样停不下来。</p>
<hr />
<h3 id="repeat">repeat</h3>
<p><code>repeat()</code> 负责把<strong>一个元素</strong>无限重复下去，不过 <code>repeat()</code> 提供了第二个参数，用于限定重复的次数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>ns = itertools.repeat(<span class="string">&#x27;A&#x27;</span>, <span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> n <span class="keyword">in</span> ns:</span><br><span class="line"><span class="meta">... </span>    <span class="built_in">print</span>(n)</span><br><span class="line">...</span><br><span class="line">A</span><br><span class="line">A</span><br><span class="line">A</span><br></pre></td></tr></table></figure>
<hr />
<h3 id="takewhile">takewhile</h3>
<p>前面介绍了几种产生“无限”迭代器的方法，有没有办法对它们进行控制呢？有的~我们可以通过 <code>takewhile()</code>等函数，根据条件判断来截取出有限的序列：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>natuals = itertools.count(<span class="number">1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ns = itertools.takewhile(<span class="keyword">lambda</span> x: x &lt;= <span class="number">10</span>, natuals)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(ns)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>]</span><br></pre></td></tr></table></figure>
<p>这里我们只截取序列中小于等于10的数，所以迭代器产生的数不符合该条件时就会停止迭代，也就不会无限地排列下去了。</p>
<p>除了 <code>takewhile()</code> 之外，<code>itertools</code> 还提供了一些非常有用的迭代器操作函数，在后面几个小节中会进行介绍。</p>
<hr />
<h3 id="chain">chain</h3>
<p><code>chain()</code> 可以把一组迭代对象串联起来，形成一个更大的迭代器：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> c <span class="keyword">in</span> itertools.chain(<span class="string">&#x27;ABC&#x27;</span>, <span class="string">&#x27;XYZ&#x27;</span>):</span><br><span class="line"><span class="meta">... </span>    <span class="built_in">print</span>(c)</span><br><span class="line">...</span><br><span class="line">A</span><br><span class="line">B</span><br><span class="line">C</span><br><span class="line">X</span><br><span class="line">Y</span><br><span class="line">Z</span><br></pre></td></tr></table></figure>
<hr />
<h3 id="groupby">groupby</h3>
<p><code>groupby()</code> 可以把迭代器中<strong>相邻的重复元素</strong>挑出来放在一起：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> key, group <span class="keyword">in</span> itertools.groupby(<span class="string">&#x27;AAABBBCCAAA&#x27;</span>):</span><br><span class="line"><span class="meta">... </span>    <span class="built_in">print</span>(key, <span class="built_in">list</span>(group))</span><br><span class="line">...</span><br><span class="line">A [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;A&#x27;</span>]</span><br><span class="line">B [<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;B&#x27;</span>]</span><br><span class="line">C [<span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;C&#x27;</span>]</span><br><span class="line">A [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;A&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>实际上挑选规则是通过函数完成的，只要作用于函数的两个元素返回的值相等，这两个元素就被认为是同一组的，而函数返回值将作为该组的key。如果我们想忽略大小写来分组，可以让元素 <code>'A'</code> 和 <code>'a'</code> 都返回相同的key：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> key, group <span class="keyword">in</span> itertools.groupby(<span class="string">&#x27;AaaBBbcCAAa&#x27;</span>, <span class="keyword">lambda</span> c: c.upper()):</span><br><span class="line"><span class="meta">... </span>    <span class="built_in">print</span>(key, <span class="built_in">list</span>(group))</span><br><span class="line">...</span><br><span class="line">A [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>]</span><br><span class="line">B [<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;b&#x27;</span>]</span><br><span class="line">C [<span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;C&#x27;</span>]</span><br><span class="line">A [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;a&#x27;</span>]</span><br></pre></td></tr></table></figure>
<hr />
<h3 id="小结">小结</h3>
<p><code>itertools</code> 模块提供的全部是处理迭代功能的函数，它们的返回值不是 <code>list</code>，而是 <code>Iterator</code>，也即它们的值不是立刻计算出放在内存中的，只有进行迭代时（例如使用 <code>for</code> 循环）才会被真正计算出来。</p>
<hr />
<p><br></p>
<h2 id="contextlib">contextlib</h2>
<h3 id="引言">引言</h3>
<p>在Python中，<strong>读写文件要注意使用完毕后必须进行关闭</strong>（文件对象占用大量资源并且同一时间操作系统只能打开有限数量的文件）。在<a target="_blank" rel="noopener" href="https://github.com/familyld/learnpython/blob/master/My_Python_Notebook/09IO%E7%BC%96%E7%A8%8B.md">09IO编程</a>中，已经介绍了利用 <code>try...finally</code> 机制关闭文件资源的方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&#x27;/path/to/file&#x27;</span>, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    f.read()</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="keyword">if</span> f:</span><br><span class="line">        f.close()</span><br></pre></td></tr></table></figure>
<p>但是，写 <code>try...finally</code> 非常繁琐，所以后续又介绍了使用 <code>with</code> 语句的方法。<code>with</code> 语句允许我们非常方便地使用资源，而不必担心资源没有关闭。使用 <code>with</code> 语句改写后，上面的代码就可以简化为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;/path/to/file&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.read()</span><br></pre></td></tr></table></figure>
<p>事实上，并不是只有 <code>open()</code> 函数返回的文件对象才能使用 <code>with</code> 语句。<strong>任何对象，只要正确实现了上下文管理，就可以用于 <code>with</code> 语句</strong>。</p>
<hr />
<h3 id="上下文管理的实现">上下文管理的实现</h3>
<p>上下文管理是通过 <code>__enter__</code> 和 <code>__exit__</code> 这两个方法实现的。下面的类就实现了这两个方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Query</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Begin&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span>(<span class="params">self, exc_type, exc_value, traceback</span>):</span></span><br><span class="line">        <span class="keyword">if</span> exc_type:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Error&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;End&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">query</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Query info about %s...&#x27;</span> % self.name)</span><br></pre></td></tr></table></figure>
<p>这样我们就可以把自己写的资源对象用于 <code>with</code> 语句：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Query(<span class="string">&#x27;Bob&#x27;</span>) <span class="keyword">as</span> q:</span><br><span class="line">    q.query()</span><br></pre></td></tr></table></figure>
<hr />
<h3 id="contextmanager装饰器"><span class="citation" data-cites="contextmanager装饰器">@contextmanager装饰器</span></h3>
<p>编写 <code>__enter__</code> 和 <code>__exit__</code> 还是太繁琐了，有没有更简单的办法呢？有！Python的标准库 <code>contextlib</code> 提供了更简单的写法，借助它，上面的代码可以改写为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Query</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">query</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Query info about %s...&#x27;</span> % self.name)</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_query</span>(<span class="params">name</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Begin&#x27;</span>)</span><br><span class="line">    q = Query(name)</span><br><span class="line">    <span class="keyword">yield</span> q</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;End&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>简单解析一下，我们定义一个简单的 <code>Query</code> 类，只有一个 <code>query()</code> 方法。同时我们定义了一个 <code>create_query()</code> 函数，由于这个函数包含 <code>yield</code> 关键字，所以实际上它是一个生成器。不过这个生成器只生成和抛出一个 <code>Query</code> 类的对象。</p>
<p><code>@contextmanager</code> 这个装饰器<strong>接收一个生成器，并为生成器抛出的对象添加上下文管理的功能</strong>。这样 <code>with</code> 语句就可以正常地工作了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> create_query(<span class="string">&#x27;Bob&#x27;</span>) <span class="keyword">as</span> q:</span><br><span class="line">    q.query()</span><br></pre></td></tr></table></figure>
<p>很多时候，我们希望在某段代码执行前后自动执行特定代码，也可以用 <code>@contextmanager</code> 实现。例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tag</span>(<span class="params">name</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&lt;%s&gt;&quot;</span> % name)</span><br><span class="line">    <span class="keyword">yield</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&lt;/%s&gt;&quot;</span> % name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tag(<span class="string">&quot;h1&quot;</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;world&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>上述代码执行结果为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line">hello</span><br><span class="line">world</span><br><span class="line"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码的执行顺序是：</p>
<ul>
<li><code>with</code> 语句首先执行 <code>yield</code> 前面的语句，因此打印出 <code>&lt;h1&gt;</code>；</li>
<li><code>yield</code> 之后会跳出生成器（<code>tag()</code> 函数），执行 <code>with</code> 语句内部的所有语句，因此打印出 <code>hello</code> 和 <code>world</code>；</li>
<li>执行完 <code>with</code> 语句内部的所有语句继续回到生成器；</li>
<li>执行 <code>yield</code> 后面的语句，打印出 <code>&lt;/h1&gt;</code>；</li>
<li>此时生成器所有语句执行完毕，不再生成，结束上下文。</li>
</ul>
<p>借助 <code>@contextmanager</code> 装饰器，我们能够更加方便地实现上下文管理。</p>
<hr />
<h3 id="closing函数">closing函数</h3>
<p>前面一节介绍了如何为一个对象实现上下文管理功能，使得它能被作用于 <code>with</code> 语句。但是，得自己编写一个生成器还是很麻烦！有没有更更方便的办法呢？有！我们可以用 <code>closing()</code> 方法！</p>
<p><code>closing()</code> 的本质如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">closing</span>(<span class="params">thing</span>):</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> thing</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        thing.close()</span><br></pre></td></tr></table></figure>
<p>其实它就是一个经过 <code>@contextmanager</code> 装饰的生成器，它的作用就是把任意对象变为上下文对象，使其支持 <code>with</code> 语句。</p>
<p>再改写一次上面 <code>Query</code> 的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> closing</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Query</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">query</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Query info about %s...&#x27;</span> % self.name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> closing(Query(<span class="string">&#x27;Bob&#x27;</span>)) <span class="keyword">as</span> q:</span><br><span class="line">    q.query()</span><br></pre></td></tr></table></figure>
<p>这次更加简单了~</p>
<p><code>@contextlib</code> 还有一些其他装饰器，可以帮助我们编写更简洁的代码。</p>
<hr />
<p><br></p>
<h2 id="xml">XML</h2>
<h3 id="简介-1">简介</h3>
<p>XML虽然比JSON复杂，在Web中应用也不如以前多了，不过仍然有很多地方会用到XML，所以我们有必要了解如何在Python中如何处理XML。</p>
<hr />
<h3 id="dom-vs-sax">DOM vs SAX</h3>
<p>一般来说，处理XML有两种方法，即DOM和SAX：</p>
<ul>
<li>DOM会先把整个XML读入内存，然后解析为树，因此DOM占用的内存大，解析慢。优点是可以任意遍历树的节点。</li>
<li>SAX则是流模式，边读边解析，占用内存小，解析快，缺点是我们需要自己处理事件。</li>
</ul>
<p><strong>正常情况下，优先考虑SAX，因为DOM实在太占内存</strong>。</p>
<hr />
<h3 id="在python中使用sax">在Python中使用SAX</h3>
<p>在Python中使用SAX解析XML非常简洁，通常我们需要关心3个事件：<code>start_element</code>，<code>end_element</code> 和 <code>char_data</code>，准备好处理这3个事件的函数后就可以解析XML了。那么这些事件到底是什么意思呢？举个例子，当SAX解析器读到一个节点时：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span>python<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>会产生3个事件：</p>
<ul>
<li><code>start_element</code> 事件：读取 <code>&lt;a href="/"&gt;</code> 时；</li>
<li><code>char_data</code> 事件：读取 <code>python</code> 时；</li>
<li><code>end_element</code> 事件：读取 <code>&lt;/a&gt;</code> 时。</li>
</ul>
<p>首先实现好处理这3个事件的函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> xml.parsers.expat <span class="keyword">import</span> ParserCreate</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_element</span>(<span class="params">name, attrs</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Start element:&#x27;</span>, name, <span class="string">&#x27;with attributes:&#x27;</span>, attrs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">end_element</span>(<span class="params">name</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;End element:&#x27;</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用repr()函数可以将字符串转换为可打印的表示方式</span></span><br><span class="line"><span class="comment"># 这样就能更清楚地观察到空白字符了</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">char_data</span>(<span class="params">data</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Character data:&#x27;</span>, <span class="built_in">repr</span>(data))</span><br></pre></td></tr></table></figure>
<p>然后创建解析器：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">p = ParserCreate()</span><br><span class="line">p.StartElementHandler = start_element</span><br><span class="line">p.EndElementHandler = end_element</span><br><span class="line">p.CharacterDataHandler = char_data</span><br></pre></td></tr></table></figure>
<p>尝试解析一个XML字符串：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">xml = <span class="string">r&#x27;&#x27;&#x27;&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="string">&lt;ol&gt;</span></span><br><span class="line"><span class="string">    &lt;li&gt;&lt;a href=&quot;/python&quot;&gt;Python&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;li&gt;&lt;a href=&quot;/ruby&quot;&gt;Ruby&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;/ol&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(p.Parse(xml))</span><br></pre></td></tr></table></figure>
<p>执行结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Start element: ol <span class="keyword">with</span> attributes: &#123;&#125;</span><br><span class="line">Character data: <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">Character data: <span class="string">&#x27;    &#x27;</span></span><br><span class="line">Start element: li <span class="keyword">with</span> attributes: &#123;&#125;</span><br><span class="line">Start element: a <span class="keyword">with</span> attributes: &#123;<span class="string">&#x27;href&#x27;</span>: <span class="string">&#x27;/python&#x27;</span>&#125;</span><br><span class="line">Character data: <span class="string">&#x27;Python&#x27;</span></span><br><span class="line">End element: a</span><br><span class="line">End element: li</span><br><span class="line">Character data: <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">Character data: <span class="string">&#x27;    &#x27;</span></span><br><span class="line">Start element: li <span class="keyword">with</span> attributes: &#123;&#125;</span><br><span class="line">Start element: a <span class="keyword">with</span> attributes: &#123;<span class="string">&#x27;href&#x27;</span>: <span class="string">&#x27;/ruby&#x27;</span>&#125;</span><br><span class="line">Character data: <span class="string">&#x27;Ruby&#x27;</span></span><br><span class="line">End element: a</span><br><span class="line">End element: li</span><br><span class="line">Character data: <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">End element: ol</span><br></pre></td></tr></table></figure>
<p><strong>注意，遇到换行符之后，即使后续还有其他内容，<code>char_data</code> 事件也会结束再被触发</strong>。因此，读取一大段文本时，<code>CharacterDataHandler</code> 可能会被多次调用，如果我们想要将文本放在一起输出而非分开输出，就要先保存下来，在 <code>EndElementHandler</code> 中再进行合并。</p>
<p>除了解析XML外，我们要如何生成XML呢？99%的情况下需要生成的XML结构都是非常简单的，因此，最简单也最有效的生成XML的方法就是拼接字符串：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">L = []</span><br><span class="line">L.append(<span class="string">r&#x27;&lt;?xml version=&quot;1.0&quot;?&gt;&#x27;</span>)</span><br><span class="line">L.append(<span class="string">r&#x27;&lt;root&gt;&#x27;</span>)</span><br><span class="line">L.append(encode(<span class="string">&#x27;some &amp; data&#x27;</span>))</span><br><span class="line">L.append(<span class="string">r&#x27;&lt;/root&gt;&#x27;</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(L)</span><br></pre></td></tr></table></figure>
<p>注意，在使用XML字符串时，我们最好<strong>使用 <code>r</code> 表示该字符串不进行转义，三引号表示保留换行</strong>，从而避免一些不必要的错误和麻烦。</p>
<p>如果要生成复杂的XML呢？这时建议不要用XML，而是改成用JSON。</p>
<hr />
<h3 id="小结-1">小结</h3>
<p>解析XML时，注意找出自己感兴趣的节点，响应事件时，可以先把节点中的数据保存起来，等待解析完毕后，再进行处理。对这一章所用模块知识感兴趣的话可以查看<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/pyexpat.html#module-xml.parsers.expat">官方文档</a>。此外，觉得自带的XML库不够给力的话可以使用更为强大的<strong>第三方库<a target="_blank" rel="noopener" href="http://lxml.de/">lxml</a></strong>。</p>
<hr />
<h3 id="练习">练习</h3>
<blockquote>
<p>编写程序使用SAX解析<a target="_blank" rel="noopener" href="http://weather.yahooapis.com/forecastrss?u=c&amp;w=2151330">Yahoo天气RSS</a>的XML格式天气预报，获取地点、当天天气和次日天气：</p>
</blockquote>
<p>由于现在Yahoo天气已经不再提供这个RSS服务了，所以链接已经失效了。这里我们直接解析一个廖老师提供好的XML字符串：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">data = <span class="string">r&#x27;&#x27;&#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot; ?&gt;</span></span><br><span class="line"><span class="string">&lt;rss version=&quot;2.0&quot; xmlns:yweather=&quot;http://xml.weather.yahoo.com/ns/rss/1.0&quot; xmlns:geo=&quot;http://www.w3.org/2003/01/geo/wgs84_pos#&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;channel&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;Yahoo! Weather - Beijing, CN&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;lastBuildDate&gt;Wed, 27 May 2015 11:00 am CST&lt;/lastBuildDate&gt;</span></span><br><span class="line"><span class="string">        &lt;yweather:location city=&quot;Beijing&quot; region=&quot;&quot; country=&quot;China&quot;/&gt;</span></span><br><span class="line"><span class="string">        &lt;yweather:units temperature=&quot;C&quot; distance=&quot;km&quot; pressure=&quot;mb&quot; speed=&quot;km/h&quot;/&gt;</span></span><br><span class="line"><span class="string">        &lt;yweather:wind chill=&quot;28&quot; direction=&quot;180&quot; speed=&quot;14.48&quot; /&gt;</span></span><br><span class="line"><span class="string">        &lt;yweather:atmosphere humidity=&quot;53&quot; visibility=&quot;2.61&quot; pressure=&quot;1006.1&quot; rising=&quot;0&quot; /&gt;</span></span><br><span class="line"><span class="string">        &lt;yweather:astronomy sunrise=&quot;4:51 am&quot; sunset=&quot;7:32 pm&quot;/&gt;</span></span><br><span class="line"><span class="string">        &lt;item&gt;</span></span><br><span class="line"><span class="string">            &lt;geo:lat&gt;39.91&lt;/geo:lat&gt;</span></span><br><span class="line"><span class="string">            &lt;geo:long&gt;116.39&lt;/geo:long&gt;</span></span><br><span class="line"><span class="string">            &lt;pubDate&gt;Wed, 27 May 2015 11:00 am CST&lt;/pubDate&gt;</span></span><br><span class="line"><span class="string">            &lt;yweather:condition text=&quot;Haze&quot; code=&quot;21&quot; temp=&quot;28&quot; date=&quot;Wed, 27 May 2015 11:00 am CST&quot; /&gt;</span></span><br><span class="line"><span class="string">            &lt;yweather:forecast day=&quot;Wed&quot; date=&quot;27 May 2015&quot; low=&quot;20&quot; high=&quot;33&quot; text=&quot;Partly Cloudy&quot; code=&quot;30&quot; /&gt;</span></span><br><span class="line"><span class="string">            &lt;yweather:forecast day=&quot;Thu&quot; date=&quot;28 May 2015&quot; low=&quot;21&quot; high=&quot;34&quot; text=&quot;Sunny&quot; code=&quot;32&quot; /&gt;</span></span><br><span class="line"><span class="string">            &lt;yweather:forecast day=&quot;Fri&quot; date=&quot;29 May 2015&quot; low=&quot;18&quot; high=&quot;25&quot; text=&quot;AM Showers&quot; code=&quot;39&quot; /&gt;</span></span><br><span class="line"><span class="string">            &lt;yweather:forecast day=&quot;Sat&quot; date=&quot;30 May 2015&quot; low=&quot;18&quot; high=&quot;32&quot; text=&quot;Sunny&quot; code=&quot;32&quot; /&gt;</span></span><br><span class="line"><span class="string">            &lt;yweather:forecast day=&quot;Sun&quot; date=&quot;31 May 2015&quot; low=&quot;20&quot; high=&quot;37&quot; text=&quot;Sunny&quot; code=&quot;32&quot; /&gt;</span></span><br><span class="line"><span class="string">        &lt;/item&gt;</span></span><br><span class="line"><span class="string">    &lt;/channel&gt;</span></span><br><span class="line"><span class="string">&lt;/rss&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>我们需要的信息有三样，分别是地点、当天天气和次日天气。在这段XML中，地点可以从 <code>yweather:location</code> 标签的 <code>city</code> 属性和 <code>country</code> 属性中获得。当天天气从第一个 <code>yweather:forecast</code> 标签的 <code>text</code>、<code>low</code> 和 <code>high</code> 这三个属性获得。次日天气则在第二个 <code>yweather:forecast</code> 标签中。并且注意到，我们只需要编写处理 <code>start_element</code> 事件的函数就可以取出所有这些信息了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> xml.parsers.expat <span class="keyword">import</span> ParserCreate</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeatherSaxHandler</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.result = <span class="built_in">dict</span>()</span><br><span class="line">        self.count = <span class="number">0</span></span><br><span class="line">        self.result[<span class="string">&#x27;forecast&#x27;</span>] = <span class="built_in">dict</span>()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_element</span>(<span class="params">self, name, attrs</span>):</span></span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">&#x27;yweather:location&#x27;</span>:</span><br><span class="line">            self.result[<span class="string">&#x27;city&#x27;</span>] = attrs[<span class="string">&#x27;city&#x27;</span>]</span><br><span class="line">            self.result[<span class="string">&#x27;country&#x27;</span>] = attrs[<span class="string">&#x27;country&#x27;</span>]</span><br><span class="line">        <span class="keyword">elif</span> name == <span class="string">&#x27;yweather:forecast&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> self.count == <span class="number">0</span>:</span><br><span class="line">                self.result[<span class="string">&#x27;forecast&#x27;</span>][<span class="string">&#x27;today&#x27;</span>] = attrs</span><br><span class="line">                self.count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> self.count == <span class="number">1</span>:</span><br><span class="line">                self.result[<span class="string">&#x27;forecast&#x27;</span>][<span class="string">&#x27;tomorrow&#x27;</span>] = attrs</span><br><span class="line">                self.count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_weather</span>(<span class="params">data</span>):</span></span><br><span class="line"></span><br><span class="line">    handler = WeatherSaxHandler()</span><br><span class="line">    p = ParserCreate()</span><br><span class="line">    p.StartElementHandler = handler.start_element</span><br><span class="line">    p.Parse(data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;city&#x27;</span>: handler.result[<span class="string">&#x27;city&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;country&#x27;</span>: handler.result[<span class="string">&#x27;country&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;today&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;text&#x27;</span>: handler.result[<span class="string">&#x27;forecast&#x27;</span>][<span class="string">&#x27;today&#x27;</span>][<span class="string">&#x27;text&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;low&#x27;</span>: <span class="built_in">int</span>(handler.result[<span class="string">&#x27;forecast&#x27;</span>][<span class="string">&#x27;today&#x27;</span>][<span class="string">&#x27;low&#x27;</span>]),</span><br><span class="line">            <span class="string">&#x27;high&#x27;</span>: <span class="built_in">int</span>(handler.result[<span class="string">&#x27;forecast&#x27;</span>][<span class="string">&#x27;today&#x27;</span>][<span class="string">&#x27;high&#x27;</span>])</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;tomorrow&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;text&#x27;</span>: handler.result[<span class="string">&#x27;forecast&#x27;</span>][<span class="string">&#x27;tomorrow&#x27;</span>][<span class="string">&#x27;text&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;low&#x27;</span>: <span class="built_in">int</span>(handler.result[<span class="string">&#x27;forecast&#x27;</span>][<span class="string">&#x27;tomorrow&#x27;</span>][<span class="string">&#x27;low&#x27;</span>]),</span><br><span class="line">            <span class="string">&#x27;high&#x27;</span>: <span class="built_in">int</span>(handler.result[<span class="string">&#x27;forecast&#x27;</span>][<span class="string">&#x27;tomorrow&#x27;</span>][<span class="string">&#x27;high&#x27;</span>])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试:</span></span><br><span class="line"></span><br><span class="line">weather = parse_weather(data)</span><br><span class="line"><span class="keyword">assert</span> weather[<span class="string">&#x27;city&#x27;</span>] == <span class="string">&#x27;Beijing&#x27;</span>, weather[<span class="string">&#x27;city&#x27;</span>]</span><br><span class="line"><span class="keyword">assert</span> weather[<span class="string">&#x27;country&#x27;</span>] == <span class="string">&#x27;China&#x27;</span>, weather[<span class="string">&#x27;country&#x27;</span>]</span><br><span class="line"><span class="keyword">assert</span> weather[<span class="string">&#x27;today&#x27;</span>][<span class="string">&#x27;text&#x27;</span>] == <span class="string">&#x27;Partly Cloudy&#x27;</span>, weather[<span class="string">&#x27;today&#x27;</span>][<span class="string">&#x27;text&#x27;</span>]</span><br><span class="line"><span class="keyword">assert</span> weather[<span class="string">&#x27;today&#x27;</span>][<span class="string">&#x27;low&#x27;</span>] == <span class="number">20</span>, weather[<span class="string">&#x27;today&#x27;</span>][<span class="string">&#x27;low&#x27;</span>]</span><br><span class="line"><span class="keyword">assert</span> weather[<span class="string">&#x27;today&#x27;</span>][<span class="string">&#x27;high&#x27;</span>] == <span class="number">33</span>, weather[<span class="string">&#x27;today&#x27;</span>][<span class="string">&#x27;high&#x27;</span>]</span><br><span class="line"><span class="keyword">assert</span> weather[<span class="string">&#x27;tomorrow&#x27;</span>][<span class="string">&#x27;text&#x27;</span>] == <span class="string">&#x27;Sunny&#x27;</span>, weather[<span class="string">&#x27;tomorrow&#x27;</span>][<span class="string">&#x27;text&#x27;</span>]</span><br><span class="line"><span class="keyword">assert</span> weather[<span class="string">&#x27;tomorrow&#x27;</span>][<span class="string">&#x27;low&#x27;</span>] == <span class="number">21</span>, weather[<span class="string">&#x27;tomorrow&#x27;</span>][<span class="string">&#x27;low&#x27;</span>]</span><br><span class="line"><span class="keyword">assert</span> weather[<span class="string">&#x27;tomorrow&#x27;</span>][<span class="string">&#x27;high&#x27;</span>] == <span class="number">34</span>, weather[<span class="string">&#x27;tomorrow&#x27;</span>][<span class="string">&#x27;high&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Weather:&#x27;</span>, <span class="built_in">str</span>(weather))</span><br></pre></td></tr></table></figure>
<hr />
<p><br></p>
<h2 id="htmlparser">HTMLParser</h2>
<h3 id="简介-2">简介</h3>
<p>如果我们要编写一个搜索引擎，第一步是用爬虫把目标网站的页面抓下来，第二步就是解析该HTML页面，看看里面的内容到底是新闻、图片还是视频。</p>
<p>假设第一步已经完成了，第二步我们应该如何解析HTML呢？</p>
<p>HTML本质上是XML的子集，但是HTML的语法没有XML那么严格，所以不能用标准的DOM或SAX来解析HTML。</p>
<p>好在Python提供了 <code>HTMLParser</code> 模块帮助我们解析HTML，非常方便，只需简单几行代码即可完成。</p>
<hr />
<h3 id="html字符实体">HTML字符实体</h3>
<p>在学习 <code>HTMLParser</code> 之前，我们需要首先了解一下HTML需要注意的地方。<strong>在HTML中，某些字符是预留的</strong>。 在HTML中不能使用小于号（<code>&lt;</code>）和大于号（<code>&gt;</code>），这是因为浏览器会误认为它们是标签符号。 如果希望正确地显示预留字符，我们必须在HTML的源代码中使用<strong><a target="_blank" rel="noopener" href="http://www.w3school.com.cn/html/html_entities.asp">字符实体（character entities）</a></strong>。</p>
<p>具体来说，常用的字符实体如下：</p>
<table class="dataintable">
<tbody>
<tr>
<th style="width:20%">
显示结果
</th>
<th style="width:20%">
描述
</th>
<th style="width:30%">
实体名称
</th>
<th style="width:30%">
实体编号
</th>
</tr>
<tr>
<td>
 
</td>
<td>
空格
</td>
<td>
&amp;nbsp;
</td>
<td>
&amp;#160;
</td>
</tr>
<tr>
<td>
&lt;
</td>
<td>
小于号
</td>
<td>
&amp;lt;
</td>
<td>
&amp;#60;
</td>
</tr>
<tr>
<td>
&gt;
</td>
<td>
大于号
</td>
<td>
&amp;gt;
</td>
<td>
&amp;#62;
</td>
</tr>
<tr>
<td>
&amp;
</td>
<td>
和号
</td>
<td>
&amp;amp;
</td>
<td>
&amp;#38;
</td>
</tr>
<tr>
<td>
"
</td>
<td>
引号
</td>
<td>
&amp;quot;
</td>
<td>
&amp;#34;
</td>
</tr>
<tr>
<td>
'
</td>
<td>
撇号 
</td>
<td>
&amp;apos; (IE不支持)
</td>
<td>
&amp;#39;
</td>
</tr>
<tr>
<td>
￠
</td>
<td>
分（cent）
</td>
<td>
&amp;cent;
</td>
<td>
&amp;#162;
</td>
</tr>
<tr>
<td>
£
</td>
<td>
镑（pound）
</td>
<td>
&amp;pound;
</td>
<td>
&amp;#163;
</td>
</tr>
<tr>
<td>
¥
</td>
<td>
元（yen）
</td>
<td>
&amp;yen;
</td>
<td>
&amp;#165;
</td>
</tr>
<tr>
<td>
€
</td>
<td>
欧元（euro）
</td>
<td>
&amp;euro;
</td>
<td>
&amp;#8364;
</td>
</tr>
<tr>
<td>
§
</td>
<td>
小节
</td>
<td>
&amp;sect;
</td>
<td>
&amp;#167;
</td>
</tr>
<tr>
<td>
©
</td>
<td>
版权（copyright）
</td>
<td>
&amp;copy;
</td>
<td>
&amp;#169;
</td>
</tr>
<tr>
<td>
®
</td>
<td>
注册商标
</td>
<td>
&amp;reg;
</td>
<td>
&amp;#174;
</td>
</tr>
<tr>
<td>
™
</td>
<td>
商标
</td>
<td>
&amp;trade;
</td>
<td>
&amp;#8482;
</td>
</tr>
<tr>
<td>
×
</td>
<td>
乘号
</td>
<td>
&amp;times;
</td>
<td>
&amp;#215;
</td>
</tr>
<tr>
<td>
÷
</td>
<td>
除号
</td>
<td>
&amp;divide;
</td>
<td>
&amp;#247;
</td>
</tr>
</tbody>
</table>
<p>完整的字符实体表可以查看W3School的<a target="_blank" rel="noopener" href="http://www.w3school.com.cn/tags/html_ref_entities.html">HTML 实体符号参考手册</a>。</p>
<p>注意到表格中有<strong>实体名称</strong>和<strong>实体编号</strong>两种形式，在编写HTML代码时这两种形式都是可以使用的。即字符实体既可以写作 <code>&amp;entity_name;</code> 的形式，也可以写作 <code>&amp;#entity_number;</code> 的形式。比如需要显示小于号时可以写作 <code>&amp;lt;</code> 也可以写作 <code>&amp;#60;</code>。使用实体名而不是编号的好处是，名称更易于记忆。不过坏处是，<strong>浏览器也许并不支持所有实体名称（但对实体编号的支持却很好）</strong>。特别地，<strong>实体编号可以写作十进制形式，也可以写作十六进制形式</strong>，<code>&amp;#60</code> 等价于 <code>&amp;#x3C</code>。</p>
<hr />
<h3 id="使用htmlparser解析html">使用HTMLParser解析HTML</h3>
<p>类似于XML的SAX解析方法，使用 <code>HTMLParser</code> 解析HTML时，我们只需要为不同的事件编写相应的处理函数就可以了。以下面的代码为例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> html.parser <span class="keyword">import</span> HTMLParser</span><br><span class="line"><span class="keyword">from</span> html.entities <span class="keyword">import</span> name2codepoint</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHTMLParser</span>(<span class="params">HTMLParser</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_starttag</span>(<span class="params">self, tag, attrs</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;This is a start tag: %s&#x27;</span> % tag)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_endtag</span>(<span class="params">self, tag</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;This is an end tag: %s&#x27;</span> % tag)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_startendtag</span>(<span class="params">self, tag, attrs</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;This is a start-end tag: %s&#x27;</span> % tag)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_data</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;This is data:&#x27;</span>, <span class="built_in">repr</span>(data))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_comment</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;This is a comment:&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_entityref</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;This is a named character reference: %s&#x27;</span> % <span class="built_in">chr</span>(name2codepoint[name]))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_charref</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        <span class="keyword">if</span> name.startswith(<span class="string">&#x27;x&#x27;</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;This is a numeric character reference: %s&#x27;</span> % <span class="built_in">chr</span>(<span class="built_in">int</span>(name[<span class="number">1</span>:], <span class="number">16</span>)))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;This is a numeric character reference: %s&#x27;</span> % <span class="built_in">chr</span>(<span class="built_in">int</span>(name)))</span><br><span class="line"></span><br><span class="line">parser = MyHTMLParser(convert_charrefs=<span class="literal">False</span>)</span><br><span class="line">parser.feed(<span class="string">r&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;Test&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;!-- test html parser --&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;My personal website is &lt;a href=&quot;http://www.2wildkids.com/&quot;&gt;www.2wildkids.com&lt;/a&gt;. Welcome to visit it.&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;img src=&quot;http://oe0e8k1nf.bkt.clouddn.com/avator-lion.jpg&quot; /&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;&amp;times; is a named character reference and &amp;#215; is a numeric character reference.</span></span><br><span class="line"><span class="string">    &lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;&#x27;&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">This <span class="keyword">is</span> data: <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">This <span class="keyword">is</span> data: <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">This <span class="keyword">is</span> a start tag: html</span><br><span class="line">This <span class="keyword">is</span> data: <span class="string">&#x27;\n    &#x27;</span></span><br><span class="line">This <span class="keyword">is</span> a start tag: head</span><br><span class="line">This <span class="keyword">is</span> data: <span class="string">&#x27;\n        &#x27;</span></span><br><span class="line">This <span class="keyword">is</span> a start tag: title</span><br><span class="line">This <span class="keyword">is</span> data: <span class="string">&#x27;Test&#x27;</span></span><br><span class="line">This <span class="keyword">is</span> an end tag: title</span><br><span class="line">This <span class="keyword">is</span> data: <span class="string">&#x27;\n    &#x27;</span></span><br><span class="line">This <span class="keyword">is</span> an end tag: head</span><br><span class="line">This <span class="keyword">is</span> data: <span class="string">&#x27;\n    &#x27;</span></span><br><span class="line">This <span class="keyword">is</span> a start tag: body</span><br><span class="line">This <span class="keyword">is</span> data: <span class="string">&#x27;\n        &#x27;</span></span><br><span class="line">This <span class="keyword">is</span> a comment:  test html parser</span><br><span class="line">This <span class="keyword">is</span> data: <span class="string">&#x27;\n        &#x27;</span></span><br><span class="line">This <span class="keyword">is</span> a start tag: p</span><br><span class="line">This <span class="keyword">is</span> data: <span class="string">&#x27;My personal website is &#x27;</span></span><br><span class="line">This <span class="keyword">is</span> a start tag: a</span><br><span class="line">This <span class="keyword">is</span> data: <span class="string">&#x27;www.2wildkids.com&#x27;</span></span><br><span class="line">This <span class="keyword">is</span> an end tag: a</span><br><span class="line">This <span class="keyword">is</span> data: <span class="string">&#x27;. Welcome to visit it.&#x27;</span></span><br><span class="line">This <span class="keyword">is</span> an end tag: p</span><br><span class="line">This <span class="keyword">is</span> data: <span class="string">&#x27;\n        &#x27;</span></span><br><span class="line">This <span class="keyword">is</span> a start-end tag: img</span><br><span class="line">This <span class="keyword">is</span> data: <span class="string">&#x27;\n        &#x27;</span></span><br><span class="line">This <span class="keyword">is</span> a start tag: p</span><br><span class="line">This <span class="keyword">is</span> a named character reference: ×</span><br><span class="line">This <span class="keyword">is</span> data: <span class="string">&#x27; is a named character reference and &#x27;</span></span><br><span class="line">This <span class="keyword">is</span> a numeric character reference: ×;</span><br><span class="line">This <span class="keyword">is</span> data: <span class="string">&#x27; is a numeric character reference.\n    &#x27;</span></span><br><span class="line">This <span class="keyword">is</span> an end tag: body</span><br><span class="line">This <span class="keyword">is</span> data: <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">This <span class="keyword">is</span> an end tag: html</span><br></pre></td></tr></table></figure>
<p><code>feed()</code> 方法可以多次调用，所以HTML字符串可以一部分一部分地塞进去，而无需一次传入完整的HTML文档。</p>
<p>代码比较简单，不需要过多地讲解。有几个小知识点需要注意一下：</p>
<ul>
<li>HTML中每个标签可能会有一些属性，比如 <code>&lt;img&gt;</code> 标签的 <code>src</code> 属性还有大小属性等等，这些属性传入事件处理函数时，会被整合到一个元组（<code>attrs</code> 参数）中，每个属性会以键值对的形式被存放在这个元组里。</li>
<li>处理实体名称需要 <code>name2codepoint</code> 这个字典，注意导入的方式。它可以将实体名称映射为十进制code point，然后再使用 <code>chr()</code> 函数就能得到对应的Unicode字符了。</li>
<li>处理实体编号需要先判断使用了十进制表示形式还是十六进制表示形式。</li>
</ul>
<p>还有一个问题，因为廖老师教程中使用的是Python3的早期版本，在早期版本中，<code>HTMLParser</code>类初始化时 <code>convert_charrefs</code> 参数默认是 <code>False</code>，不会把HTML字符串中的字符实体转换为Unicode字符。而在Python3.5版本中，这一参数被修改为默认是 <code>True</code>，所以传入HTML字符串时会自动进行转换，转换后自然就无法触发 <code>handle_entityref()</code> 事件和 <code>handle_charref()</code> 事件了。这个小问题刚开始也让我小卡了一下，在查看<a target="_blank" rel="noopener" href="https://docs.python.org/3.5/library/html.parser.html?highlight=htmlparser">官方文档</a>后终于解决了问题。</p>
<hr />
<h3 id="小结-2">小结</h3>
<p>借助 <code>HTMLParser</code> 模块，我们可以非常方便地把网页中的文本、图像等解析出来。此外，我们也可以使用更为强大的<a target="_blank" rel="noopener" href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/index.zh.html">第三方库 <code>BeautifulSoup</code></a>。</p>
<hr />
<h3 id="练习-1">练习</h3>
<blockquote>
<p>查看<a target="_blank" rel="noopener" href="https://www.python.org/events/python-events/">Python官网的新闻页</a>，用浏览器查看该网页的源码，尝试解析出Python官网发布的会议名称、时间和地点。</p>
</blockquote>
<p>由于源码较长，所以就不在笔记中展示出来了，源码文件 <code>Our Events _ Python.org.html</code> 放在<a target="_blank" rel="noopener" href="https://github.com/familyld/learnpython/blob/master/My_Python_Notebook/Res">Res目录</a>下。</p>
<p>首先分析一下源码，会议名称、时间和地点在源码中是这样表示的：</p>
<p><strong>会议名称</strong>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">&quot;event-title&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://www.python.org/events/python-events/491/&quot;</span>&gt;</span>PyCon Belarus 2017<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>会议时间</strong>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">time</span> <span class="attr">datetime</span>=<span class="string">&quot;2017-02-04T00:00:00+00:00&quot;</span>&gt;</span>04 Feb. – 05 Feb. <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;say-no-more&quot;</span>&gt;</span> 2017<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">time</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>会议地点</strong>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;event-location&quot;</span>&gt;</span>Minsk, Belarus<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>并且，出现会议名称后一定会紧接着出现相应的会议时间和会议地点。因此，提取策略可以分为以下步骤：</p>
<ol type="1">
<li><strong>提取会议名称</strong>：在 <code>h3</code> 标签触发 <code>handle_starttag</code> 事件时，判断其 <code>class</code> 属性是否为 <code>event-title</code> ，是则紧接着触发的一次 <code>handle_data</code> 事件所得的就是会议名称。</li>
<li><strong>提取会议时间</strong>：在 <code>time</code> 标签触发 <code>handle_starttag</code> 事件时，则紧接着触发的两次 <code>handle_data</code> 事件所得的分别是会议日期和年份。</li>
<li><strong>提取会议地点</strong>：在 <code>span</code> 标签触发 <code>handle_starttag</code> 事件时，判断其 <code>class</code> 属性是否为 <code>event-location</code> ，是则紧接着触发的一次 <code>handle_data</code> 事件所得的就是会议地点。</li>
</ol>
<p>我们可以设置一个 <code>flag</code> 变量来标记触发事件的标签，方便在 <code>handle_data</code> 时判断处理。又因为会议日期和年份是分开的，我们可以使用一个中间变量 <code>date</code> 来暂存日期，待和年份合并后再进行输出。</p>
<p>代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> html.parser <span class="keyword">import</span> HTMLParser</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHTMLParser</span>(<span class="params">HTMLParser</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, **kw</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(**kw)</span><br><span class="line">        self.flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        self.date = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_starttag</span>(<span class="params">self, tag, attrs</span>):</span></span><br><span class="line">        <span class="keyword">if</span> tag == <span class="string">&#x27;h3&#x27;</span>:</span><br><span class="line">            <span class="keyword">for</span> attr <span class="keyword">in</span> attrs:</span><br><span class="line">                <span class="keyword">if</span> attr[<span class="number">0</span>] == <span class="string">&#x27;class&#x27;</span> <span class="keyword">and</span> attr[<span class="number">1</span>] == <span class="string">&#x27;event-title&#x27;</span>:</span><br><span class="line">                    self.flag = <span class="string">&#x27;title&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> tag == <span class="string">&#x27;time&#x27;</span>:</span><br><span class="line">            self.flag = <span class="string">&#x27;time&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> tag == <span class="string">&#x27;span&#x27;</span>:</span><br><span class="line">            <span class="keyword">for</span> attr <span class="keyword">in</span> attrs:</span><br><span class="line">                <span class="keyword">if</span> attr[<span class="number">0</span>] == <span class="string">&#x27;class&#x27;</span> <span class="keyword">and</span> attr[<span class="number">1</span>] == <span class="string">&#x27;event-location&#x27;</span>:</span><br><span class="line">                    self.flag = <span class="string">&#x27;location&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_data</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.flag == <span class="string">&#x27;title&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;会议名称:&#x27;</span>, data)</span><br><span class="line">            self.flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> self.flag == <span class="string">&#x27;time&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> self.date == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">                self.date = self.date + data</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.date = self.date + data</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;会议时间:&#x27;</span>, self.date)</span><br><span class="line">                self.date = <span class="string">&#x27;&#x27;</span></span><br><span class="line">                self.flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> self.flag == <span class="string">&#x27;location&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;会议地点:&#x27;</span>, data, <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">            self.flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">r&#x27;E:\wheels\learnpython\My_Python_Notebook\Res\Our Events _ Python.org.html&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line"></span><br><span class="line">    html = f.read()</span><br><span class="line">    parser = MyHTMLParser(convert_charrefs=<span class="literal">False</span>)</span><br><span class="line">    parser.feed(html)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">会议名称: PyCon Belarus <span class="number">2017</span></span><br><span class="line">会议时间: 04 Feb. – 05 Feb.  <span class="number">2017</span></span><br><span class="line">会议地点: Minsk, Belarus</span><br><span class="line"></span><br><span class="line">会议名称: PyTennessee <span class="number">2017</span></span><br><span class="line">会议时间: 04 Feb. – 06 Feb.  <span class="number">2017</span></span><br><span class="line">会议地点: Nashville, Tennessee, USA</span><br><span class="line"></span><br><span class="line">会议名称: PythonFOSDEM <span class="number">2017</span></span><br><span class="line">会议时间: 04 Feb. – 06 Feb.  <span class="number">2017</span></span><br><span class="line">会议地点: Université Libre de Bruxelles, Franklin Rooseveltlaan <span class="number">50</span>, <span class="number">1050</span> Brussel, Belgium</span><br><span class="line"></span><br><span class="line">会议名称: FOSDEM <span class="number">2017</span></span><br><span class="line">会议时间: 04 Feb. – 06 Feb.  <span class="number">2017</span></span><br><span class="line">会议地点: Université Libre de Bruxelles, Franklin Rooseveltlaan <span class="number">50</span>, <span class="number">1050</span> Brussel, Belgium</span><br><span class="line"></span><br><span class="line">会议名称: PyCon Colombia <span class="number">2017</span></span><br><span class="line">会议时间: <span class="number">10</span> Feb. – <span class="number">12</span> Feb.  <span class="number">2017</span></span><br><span class="line">会议地点: Bogota, Colombia</span><br><span class="line"></span><br><span class="line">会议名称: PyCon Pune <span class="number">2017</span></span><br><span class="line">会议时间: <span class="number">16</span> Feb. – <span class="number">20</span> Feb.  <span class="number">2017</span></span><br><span class="line">会议地点: COEP, Pune, India</span><br><span class="line"></span><br><span class="line">会议名称: PyCon Cameroon</span><br><span class="line">会议时间: <span class="number">20</span> Jan. – <span class="number">23</span> Jan.  <span class="number">2017</span></span><br><span class="line">会议地点: Molyko Buea,Cameroon</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr />
<p><br></p>
<h2 id="urllib">urllib</h2>
<h3 id="简介-3">简介</h3>
<p><code>urllib</code> 库提供了一系列用于操作URL的功能。</p>
<hr />
<h3 id="get">Get</h3>
<p><code>urllib</code> 的 <code>request</code> 模块可以非常方便地抓取URL内容，<code>urlopen()</code> 函数首先发送一个GET请求到指定的页面，然后返回HTTP的响应。比方说，对豆瓣的一个URL（<a target="_blank" rel="noopener" href="https://api.douban.com/v2/book/2129650">https://api.douban.com/v2/book/2129650</a>）进行抓取，并返回响应：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> request.urlopen(<span class="string">&#x27;https://api.douban.com/v2/book/2129650&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.read()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Status:&#x27;</span>, f.status, f.reason)</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> f.getheaders():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s: %s&#x27;</span> % (k, v))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Data:&#x27;</span>, data.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p>可以看到HTTP响应状态，header，以及返回的JSON数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Status: <span class="number">200</span> OK</span><br><span class="line">Server: nginx</span><br><span class="line">Date: Tue, <span class="number">26</span> May <span class="number">2015</span> <span class="number">10</span>:02:<span class="number">27</span> GMT</span><br><span class="line">Content-<span class="type">Type</span>: application/json; charset=utf-<span class="number">8</span></span><br><span class="line">Content-Length: <span class="number">2049</span></span><br><span class="line">Connection: close</span><br><span class="line">Expires: Sun, <span class="number">1</span> Jan <span class="number">2006</span> 01:<span class="number">00</span>:<span class="number">00</span> GMT</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: must-revalidate, no-cache, private</span><br><span class="line">X-DAE-Node: pidl1</span><br><span class="line">Data: &#123;<span class="string">&quot;rating&quot;</span>:&#123;<span class="string">&quot;max&quot;</span>:<span class="number">10</span>,<span class="string">&quot;numRaters&quot;</span>:<span class="number">16</span>,<span class="string">&quot;average&quot;</span>:<span class="string">&quot;7.4&quot;</span>,<span class="string">&quot;min&quot;</span>:<span class="number">0</span>&#125;,<span class="string">&quot;subtitle&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;author&quot;</span>:[<span class="string">&quot;廖雪峰编著&quot;</span>],<span class="string">&quot;pubdate&quot;</span>:<span class="string">&quot;2007-6&quot;</span>,<span class="string">&quot;tags&quot;</span>:[&#123;<span class="string">&quot;count&quot;</span>:<span class="number">20</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;spring&quot;</span>,<span class="string">&quot;title&quot;</span>:<span class="string">&quot;spring&quot;</span>&#125;...&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们要想<strong>模拟浏览器发送GET请求</strong>，就需要使用 <code>Request</code> 对象，通过往 <code>Request</code> 对象添加HTTP头，我们就可以把请求伪装成浏览器。例如，模拟iPhone 6去请求豆瓣首页：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line">req = request.Request(<span class="string">&#x27;http://www.douban.com/&#x27;</span>)</span><br><span class="line">req.add_header(<span class="string">&#x27;User-Agent&#x27;</span>, <span class="string">&#x27;Mozilla/6.0 (iPhone; CPU iPhone OS 8_0 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko) Version/8.0 Mobile/10A5376e Safari/8536.25&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> request.urlopen(req) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Status:&#x27;</span>, f.status, f.reason)</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> f.getheaders():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s: %s&#x27;</span> % (k, v))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Data:&#x27;</span>, f.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p>这样豆瓣会返回适合iPhone的移动版网页：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;format-detection&quot;</span> content=<span class="string">&quot;telephone=no&quot;</span>&gt;</span><br><span class="line">    &lt;link rel=<span class="string">&quot;apple-touch-icon&quot;</span> sizes=<span class="string">&quot;57x57&quot;</span> href=<span class="string">&quot;http://img4.douban.com/pics/cardkit/launcher/57.png&quot;</span> /&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<hr />
<h3 id="post">Post</h3>
<p>如果要以POST方式发送一个请求，就需要<strong>把参数数据以bytes的形式传入</strong>。</p>
<p>比方说，我们模拟微博登录，需要先读取用于登录的邮箱和口令，然后按照 <a href="weibo.cn">weibo.cn</a> 登录页的格式以 <code>username=xxx&amp;password=xxx</code> 的方式来传入：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request, parse</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Login to weibo.cn...&#x27;</span>)</span><br><span class="line">email = <span class="built_in">input</span>(<span class="string">&#x27;Email: &#x27;</span>)</span><br><span class="line">passwd = <span class="built_in">input</span>(<span class="string">&#x27;Password: &#x27;</span>)</span><br><span class="line">login_data = parse.urlencode([</span><br><span class="line">    (<span class="string">&#x27;username&#x27;</span>, email),</span><br><span class="line">    (<span class="string">&#x27;password&#x27;</span>, passwd),</span><br><span class="line">    (<span class="string">&#x27;entry&#x27;</span>, <span class="string">&#x27;mweibo&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;client_id&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;savestate&#x27;</span>, <span class="string">&#x27;1&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;ec&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;pagerefer&#x27;</span>, <span class="string">&#x27;https://passport.weibo.cn/signin/welcome?entry=mweibo&amp;r=http%3A%2F%2Fm.weibo.cn%2F&#x27;</span>)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">req = request.Request(<span class="string">&#x27;https://passport.weibo.cn/sso/login&#x27;</span>)</span><br><span class="line">req.add_header(<span class="string">&#x27;Origin&#x27;</span>, <span class="string">&#x27;https://passport.weibo.cn&#x27;</span>)</span><br><span class="line">req.add_header(<span class="string">&#x27;User-Agent&#x27;</span>, <span class="string">&#x27;Mozilla/6.0 (iPhone; CPU iPhone OS 8_0 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko) Version/8.0 Mobile/10A5376e Safari/8536.25&#x27;</span>)</span><br><span class="line">req.add_header(<span class="string">&#x27;Referer&#x27;</span>, <span class="string">&#x27;https://passport.weibo.cn/signin/login?entry=mweibo&amp;res=wel&amp;wm=3349&amp;r=http%3A%2F%2Fm.weibo.cn%2F&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> request.urlopen(req, data=login_data.encode(<span class="string">&#x27;utf-8&#x27;</span>)) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Status:&#x27;</span>, f.status, f.reason)</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> f.getheaders():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s: %s&#x27;</span> % (k, v))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Data:&#x27;</span>, f.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p>如果登录成功，我们获得的响应如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Status: <span class="number">200</span> OK</span><br><span class="line">Server: nginx/<span class="number">1.2</span><span class="number">.0</span></span><br><span class="line">...</span><br><span class="line"><span class="type">Set</span>-Cookie: SSOLoginState=<span class="number">1432620126</span>; path=/; domain=weibo.cn</span><br><span class="line">...</span><br><span class="line">Data: &#123;<span class="string">&quot;retcode&quot;</span>:<span class="number">20000000</span>,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;data&quot;</span>:&#123;...,<span class="string">&quot;uid&quot;</span>:<span class="string">&quot;1658384301&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>如果登录失败，我们获得的响应如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Data: &#123;<span class="string">&quot;retcode&quot;</span>:<span class="number">50011015</span>,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;\u7528\u6237\u540d\u6216\u5bc6\u7801\u9519\u8bef&quot;</span>,<span class="string">&quot;data&quot;</span>:&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;example@python.org&quot;</span>,<span class="string">&quot;errline&quot;</span>:<span class="number">536</span>&#125;&#125;</span><br><span class="line">Handler</span><br></pre></td></tr></table></figure>
<p>如果还需要更复杂的控制，比如通过一个<a target="_blank" rel="noopener" href="http://baike.baidu.com/link?url=5YFSQ99ffvFNdUhG-6B5uZDPbFd21G-7occaszKEl8F3tWuikeXQde0JgTz62mUiC3tHpLgMfG_AR0qAz6leFbPtysU13Um4sR4_gkug0PbOE7GudBm9cXhJIqMY37X-4h_AD6gZP79pMzwCjQy8XDLKOCWqLw1EPryESUSkIgNiT8T2i7zTzNXEJIAuzXVY">代理服务器(Proxy)</a> 去访问网站，我们需要利用 <code>ProxyHandler</code> 来处理，示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">proxy_handler = urllib.request.ProxyHandler(&#123;<span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://www.example.com:3128/&#x27;</span>&#125;)</span><br><span class="line">proxy_auth_handler = urllib.request.ProxyBasicAuthHandler()</span><br><span class="line">proxy_auth_handler.add_password(<span class="string">&#x27;realm&#x27;</span>, <span class="string">&#x27;host&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">opener = urllib.request.build_opener(proxy_handler, proxy_auth_handler)</span><br><span class="line"><span class="keyword">with</span> opener.<span class="built_in">open</span>(<span class="string">&#x27;http://www.example.com/login.html&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<hr />
<h3 id="小结-3">小结</h3>
<p><code>urllib</code> 提供的功能就是利用程序去执行各种HTTP请求。如果要模拟浏览器完成特定功能，需要把请求伪装成浏览器。伪装的方法是先监控浏览器发出的请求，再根据浏览器的发出的请求中的header来伪装，User-Agent就是用来标识浏览器的。</p>
<hr />
<h3 id="练习-2">练习</h3>
<blockquote>
<p>利用 <code>urllib</code> 读取XML，将XML一节的天气预报数据由硬编码改为由 <code>urllib</code> 获取</p>
</blockquote>
<p>由于雅虎天气API已经跪了，这里改用百度天气API来尝试。</p>
<p>接口例子：<a target="_blank" rel="noopener" href="http://api.map.baidu.com/telematics/v3/weather?location=广州&amp;ak=8IoIaU655sQrs95uMWRWPDIa">http://api.map.baidu.com/telematics/v3/weather?location=广州&amp;ak=8IoIaU655sQrs95uMWRWPDIa</a></p>
<p>代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> xml.parsers.expat <span class="keyword">import</span> ParserCreate</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeatherSaxHandler</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.result = <span class="built_in">dict</span>()</span><br><span class="line">        self.currentTag = <span class="string">&#x27;&#x27;</span> <span class="comment">#</span></span><br><span class="line">        self.flag = <span class="literal">True</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_element</span>(<span class="params">self, name, attrs</span>):</span></span><br><span class="line">        self.currentTag = name</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">char_data</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.flag == <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">if</span> self.currentTag == <span class="string">&#x27;currentCity&#x27;</span>:</span><br><span class="line">                self.result[<span class="string">&#x27;城市&#x27;</span>] = data</span><br><span class="line">            <span class="keyword">elif</span> self.currentTag == <span class="string">&#x27;date&#x27;</span>:</span><br><span class="line">                self.result[<span class="string">&#x27;当前&#x27;</span>] = data</span><br><span class="line">            <span class="keyword">elif</span> self.currentTag == <span class="string">&#x27;weather&#x27;</span>:</span><br><span class="line">                self.result[<span class="string">&#x27;天气&#x27;</span>] = data</span><br><span class="line">            <span class="keyword">elif</span> self.currentTag == <span class="string">&#x27;wind&#x27;</span>:</span><br><span class="line">                self.result[<span class="string">&#x27;风速&#x27;</span>] = data</span><br><span class="line">            <span class="keyword">elif</span> self.currentTag == <span class="string">&#x27;temperature&#x27;</span>:</span><br><span class="line">                self.result[<span class="string">&#x27;气温&#x27;</span>] = data</span><br><span class="line">                self.flag = <span class="literal">False</span></span><br><span class="line">            self.currentTag = <span class="string">&#x27;&#x27;</span> <span class="comment"># 记得每次解析完信息要重置</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_weather</span>(<span class="params">data</span>):</span></span><br><span class="line"></span><br><span class="line">    handler = WeatherSaxHandler()</span><br><span class="line">    p = ParserCreate()</span><br><span class="line">    p.StartElementHandler = handler.start_element</span><br><span class="line">    p.CharacterDataHandler = handler.char_data</span><br><span class="line">    p.Parse(data)</span><br><span class="line">    <span class="keyword">return</span> handler.result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fetch_xml</span>(<span class="params">url</span>):</span></span><br><span class="line">    <span class="keyword">with</span> request.urlopen(url) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read().decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Status:&#x27;</span>, f.status, f.reason)</span><br><span class="line">        <span class="keyword">return</span> parse_weather(data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line"><span class="built_in">print</span>(fetch_xml(<span class="string">&#x27;http://api.map.baidu.com/telematics/v3/weather?location=guangzhou&amp;ak=8IoIaU655sQrs95uMWRWPDIa&#x27;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Status: <span class="number">200</span> OK</span><br><span class="line">&#123;<span class="string">&#x27;气温&#x27;</span>: <span class="string">&#x27;21 ~ 14℃&#x27;</span>, <span class="string">&#x27;城市&#x27;</span>: <span class="string">&#x27;guangzhou&#x27;</span>, <span class="string">&#x27;风速&#x27;</span>: <span class="string">&#x27;微风&#x27;</span>, <span class="string">&#x27;当前&#x27;</span>: <span class="string">&#x27;周六 02月04日 (实时：19℃)&#x27;</span>, <span class="string">&#x27;天气&#x27;</span>: <span class="string">&#x27;小雨&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>
<hr />
<p><br></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>常用内建模块（下）</p><p><a href="https://hunlp.com/posts/32532.html">https://hunlp.com/posts/32532.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>ฅ´ω`ฅ</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2017-06-28</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-06-08</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <a class="link-muted" rel="tag" href="/tags/%E7%AC%94%E8%AE%B0/">笔记 </a></div></div><div class="bdsharebuttonbox"><a class="bds_more" href="#" data-cmd="more"></a><a class="bds_qzone" href="#" data-cmd="qzone" title="分享到QQ空间"></a><a class="bds_tsina" href="#" data-cmd="tsina" title="分享到新浪微博"></a><a class="bds_tqq" href="#" data-cmd="tqq" title="分享到腾讯微博"></a><a class="bds_renren" href="#" data-cmd="renren" title="分享到人人网"></a><a class="bds_weixin" href="#" data-cmd="weixin" title="分享到微信"></a></div><script>window._bd_share_config = { "common": { "bdSnsKey": {}, "bdText": "", "bdMini": "2", "bdPic": "", "bdStyle": "0", "bdSize": "16" }, "share": {} }; with (document) 0[(getElementsByTagName('head')[0] || body).appendChild(createElement('script')).src = 'http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion=' + ~(-new Date() / 36e5)];</script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/zfb.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wx.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/posts/21992.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Numpy 学习</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/posts/33557.html"><span class="level-item">常用内建模块（上）</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "23d928ebe072da18fc4b4ec7d34db29e",
            repo: "Cartride.github.io",
            owner: "Cartride",
            clientID: "8f4a2426c347380a6ee4",
            clientSecret: "8dc8cd44b071426b35d0bd60634941371170b798",
            admin: ["Cartride"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#itertools"><span class="level-left"><span class="level-item">1</span><span class="level-item">itertools</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#简介"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">简介</span></span></a></li><li><a class="level is-mobile" href="#count"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">count</span></span></a></li><li><a class="level is-mobile" href="#cycle"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">cycle</span></span></a></li><li><a class="level is-mobile" href="#repeat"><span class="level-left"><span class="level-item">1.4</span><span class="level-item">repeat</span></span></a></li><li><a class="level is-mobile" href="#takewhile"><span class="level-left"><span class="level-item">1.5</span><span class="level-item">takewhile</span></span></a></li><li><a class="level is-mobile" href="#chain"><span class="level-left"><span class="level-item">1.6</span><span class="level-item">chain</span></span></a></li><li><a class="level is-mobile" href="#groupby"><span class="level-left"><span class="level-item">1.7</span><span class="level-item">groupby</span></span></a></li><li><a class="level is-mobile" href="#小结"><span class="level-left"><span class="level-item">1.8</span><span class="level-item">小结</span></span></a></li></ul></li><li><a class="level is-mobile" href="#contextlib"><span class="level-left"><span class="level-item">2</span><span class="level-item">contextlib</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#引言"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">引言</span></span></a></li><li><a class="level is-mobile" href="#上下文管理的实现"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">上下文管理的实现</span></span></a></li><li><a class="level is-mobile" href="#contextmanager装饰器"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">@contextmanager装饰器</span></span></a></li><li><a class="level is-mobile" href="#closing函数"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">closing函数</span></span></a></li></ul></li><li><a class="level is-mobile" href="#xml"><span class="level-left"><span class="level-item">3</span><span class="level-item">XML</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#简介-1"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">简介</span></span></a></li><li><a class="level is-mobile" href="#dom-vs-sax"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">DOM vs SAX</span></span></a></li><li><a class="level is-mobile" href="#在python中使用sax"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">在Python中使用SAX</span></span></a></li><li><a class="level is-mobile" href="#小结-1"><span class="level-left"><span class="level-item">3.4</span><span class="level-item">小结</span></span></a></li><li><a class="level is-mobile" href="#练习"><span class="level-left"><span class="level-item">3.5</span><span class="level-item">练习</span></span></a></li></ul></li><li><a class="level is-mobile" href="#htmlparser"><span class="level-left"><span class="level-item">4</span><span class="level-item">HTMLParser</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#简介-2"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">简介</span></span></a></li><li><a class="level is-mobile" href="#html字符实体"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">HTML字符实体</span></span></a></li><li><a class="level is-mobile" href="#使用htmlparser解析html"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">使用HTMLParser解析HTML</span></span></a></li><li><a class="level is-mobile" href="#小结-2"><span class="level-left"><span class="level-item">4.4</span><span class="level-item">小结</span></span></a></li><li><a class="level is-mobile" href="#练习-1"><span class="level-left"><span class="level-item">4.5</span><span class="level-item">练习</span></span></a></li></ul></li><li><a class="level is-mobile" href="#urllib"><span class="level-left"><span class="level-item">5</span><span class="level-item">urllib</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#简介-3"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">简介</span></span></a></li><li><a class="level is-mobile" href="#get"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">Get</span></span></a></li><li><a class="level is-mobile" href="#post"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">Post</span></span></a></li><li><a class="level is-mobile" href="#小结-3"><span class="level-left"><span class="level-item">5.4</span><span class="level-item">小结</span></span></a></li><li><a class="level is-mobile" href="#练习-2"><span class="level-left"><span class="level-item">5.5</span><span class="level-item">练习</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="MCFON" height="28"></a><p class="is-size-7"><span>&copy; 2022 ฅ´ω`ฅ</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>